# name: test/sql/paimon.test
# description: test paimon extension
# group: [sql]

# Before we load the extension, this will fail
statement error
SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T');
----
Catalog Error: Table Function with name paimon_read does not exist!

# Allow unsigned extensions to be loaded
require paimon


# Confirm the extension is loaded
query I
SELECT extension_name FROM duckdb_extensions() WHERE extension_name = 'paimon';
----
paimon

# Test paimon_read function - verify it can be called and returns schema
# This will succeed even if the table is empty, as long as the table exists
statement ok
SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') LIMIT 0;

# Verify the function returns the correct number of rows
query I
SELECT COUNT(*) FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T');
----
2

# Test with explicit database parameter (should be same as default)
query I
SELECT COUNT(*) FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T');
----
2

# Verify we can query the table function multiple times
statement ok
SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') LIMIT 10;

# Verify the function works with WHERE clause (if table has data)
statement ok
SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') WHERE 1=0;

# Verify we can get column information using DESCRIBE
statement ok
DESCRIBE SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T');

# Verify the function returns consistent results
query I
SELECT COUNT(*) FROM (
    SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T')
);
----
2

# Test that the function can be used in a CTE
query I
WITH paimon_data AS (
    SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T')
)
SELECT COUNT(*) FROM paimon_data;
----
2

# Verify the actual data content - check all rows
query TTT
SELECT * FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') ORDER BY a;
----
1	2	3
4	5	6

# Verify column names and data types
query TTT
SELECT a, b, c FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') ORDER BY a;
----
1	2	3
4	5	6

# Verify we can filter data
query I
SELECT COUNT(*) FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') WHERE a = '1';
----
1

# Verify we can select specific columns
query T
SELECT a FROM paimon_read('/Users/yuxia/Projects/fluss-demo/paimon-warehouse', 'default', 'T') ORDER BY a;
----
1
4

